(()=>{"use strict";var e={91:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationDataDecrypter=void 0;const i=r(113);t.ApplicationDataDecrypter=class{static Decrypt(e){console.log(e),console.log("applicationDataUnit.apduBuffer hex",e.apduBuffer.toString("hex")),console.log("applicationDataUnit.encryptedPayload hex",e.encryptedPayload.toString("hex"));const t=Buffer.from("***REMOVED***","hex"),r=Buffer.concat([e.systemTitle,e.frameCounter]);e.encryptedPayload.length,Buffer.alloc(12).fill(0);const a=Buffer.concat([r,Buffer.from("00000002","hex")]);let n=i.createDecipheriv("aes-128-ctr",t,a);const s=n.update(e.encryptedPayload);console.log("update",s.toString("hex"));const l=n.final();console.log("final",l.toString("hex")),e.decryptedPayload=Buffer.concat([s,l]),console.log(`Decrypted: \t${e.decryptedPayload.toString("hex")}`),console.log(`Decrypted: \t"${e.decryptedPayload.toString("utf-8")}"`),console.log(`Decrypted: \t"${e.decryptedPayload.toString()}"`)}}},535:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationProtocolDataUnit=void 0;const i=r(82),a=r(97);t.ApplicationProtocolDataUnit=class{setSystemTitle(e){if(this._systemTitle=e,this._systemTitleManufacturerId=e.subarray(0,3).toString(),"KFM"==this._systemTitleManufacturerId){let t=e[3].toString(16).padStart(2,"0"),r=e[4].toString(16).padStart(2,"0"),i=a.Tools.getNumberFromBuffer(e,5,8).toString().padStart(7,"0");this._serialNumber=t[0]+this._systemTitleManufacturerId+t[1]+r+i}else{let t=0;for(;t<5&&e[3+t]>=48&&e[3+t]<=122;)t++;let r="",i="";if(t>0&&(r=e.subarray(3,3+t).toString()),3+t<8){let r=Math.pow(256,5-t).toString().length;i=a.Tools.getNumberFromByteArray([...e.subarray(3+t,8)]).toString().padStart(r,"0")}this._serialNumber=this._systemTitleManufacturerId+r+i}}get systemTitle(){return this._systemTitle}get systemTitleManufacturerId(){return this._systemTitleManufacturerId}setLength(e,t=0,r){return null==r&&(r=e.length),130==e[t]?(this._lengthField=a.Tools.getNumberFromBuffer(e,t+1,r),this._lengthFieldLength=3):(this._lengthField=e[t],this._lengthFieldLength=1),this._lengthEncryptedPayload=this._lengthField-5,this._lengthTotal=this._lengthField+this._lengthFieldLength+10,this._lengthFieldLength}get lengthFieldLength(){return this._lengthFieldLength}get lengthTotal(){return this._lengthTotal}get lengthEncryptedPayload(){return this._lengthEncryptedPayload}get lengthField(){return this._lengthField}set securityControl(e){this._securityControl=e,this._securitySuiteId=15&this._securityControl,this._securityAuthentication=16==(16&this._securityControl),this._securityEncryption=32==(32&this._securityControl),this._securityKeySet=64==(64&this._securityControl)?i.KeySet.broadcast:i.KeySet.unicast,this._securityCompression=128==(128&this._securityControl)}get securityControl(){return this._securityControl}get securitySuiteId(){return this._securitySuiteId}get securityAuthentication(){return this._securityAuthentication}get securityEncryption(){return this._securityEncryption}get securityKeySet(){return this._securityKeySet}get securityCompression(){return this._securityCompression}setFrameCounter(e,t=0,r){this._frameCounter=e.subarray(t,r),this._frameCounterNumber=a.Tools.getNumberFromBuffer(this._frameCounter)}get frameCounter(){return this._frameCounter}get frameCounterNumber(){return this._frameCounterNumber}}},82:(e,t)=>{var r,i,a,n;Object.defineProperty(t,"__esModule",{value:!0}),t.KeySet=t.ApplicationDataProvisioning=t.ApplicationDataState=t.TelegramState=void 0,(n=t.TelegramState||(t.TelegramState={}))[n.pending=0]="pending",n[n.available=1]="available",(a=t.ApplicationDataState||(t.ApplicationDataState={}))[a.pending=0]="pending",a[a.available=1]="available",(i=t.ApplicationDataProvisioning||(t.ApplicationDataProvisioning={}))[i.lastOnly=0]="lastOnly",i[i.all=1]="all",(r=t.KeySet||(t.KeySet={}))[r.unicast=0]="unicast",r[r.broadcast=1]="broadcast"},222:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MultiTelegramReader=void 0;const i=r(82),a=r(535),n=r(91);class s{constructor(e,t=i.ApplicationDataProvisioning.lastOnly){this.telegramReader=e,this.provisioning=t,this.applicationDataUnits=[],this.currentApplicationDataUnit=new a.ApplicationProtocolDataUnit,this.currentApplicationDataUnits=[],this.currentSequenceNumber=0}areApplicationDataUnitsAvailable(){return this.applicationDataUnits.length>0?i.ApplicationDataState.available:i.ApplicationDataState.pending}addRawData(e){if(this.telegramReader.addRawData(e)==i.TelegramState.available){const e=this.telegramReader.getTelegrams();return this.addTelegrams(e)}return this.areApplicationDataUnitsAvailable()}addTelegrams(e){for(let t of e)if(t.sequenceNumber==this.currentSequenceNumber){if(0===t.sequenceNumber){if(t.applicationData.length<17){console.warn(`addTelegrams: Application data length of first telegram in sequence invalid. Start over. Expected: >= 17. Received: ${t.applicationData.length}`),this.resetSearch();continue}if(this.currentApplicationDataUnit.cypheringService=t.applicationData[0],this.currentApplicationDataUnit.cypheringService!=s.CypheringServiceGeneralGloCiphering){console.warn(`addTelegrams: Application data cyphering service invalid. Start over. Expected: ${s.CypheringServiceGeneralGloCiphering.toString(16)}. Received: ${this.currentApplicationDataUnit.cypheringService.toString(16)}`),this.resetSearch();continue}this.currentApplicationDataUnit.setSystemTitle(t.applicationData.subarray(2,10));const e=this.currentApplicationDataUnit.setLength(t.applicationData,10,13)-1;this.currentApplicationDataUnit.securityControl=t.applicationData[11+e],this.currentApplicationDataUnit.setFrameCounter(t.applicationData,12+e,16+e)}this.currentApplicationDataUnits.push(t.applicationData),t.isLastSegment?(this.currentApplicationDataUnit.apduBuffer=Buffer.concat(this.currentApplicationDataUnits),this.currentApplicationDataUnit.encryptedPayload=this.currentApplicationDataUnit.apduBuffer.subarray(16+this.currentApplicationDataUnit.lengthFieldLength-1),n.ApplicationDataDecrypter.Decrypt(this.currentApplicationDataUnit),this.currentApplicationDataUnit.lengthEncryptedPayload==this.currentApplicationDataUnit.encryptedPayload.length?(this.provisioning==i.ApplicationDataProvisioning.all?this.applicationDataUnits.push(this.currentApplicationDataUnit):this.applicationDataUnits=[this.currentApplicationDataUnit],this.resetSearch()):(console.warn(`addTelegrams: Application data length of combined segments invalid. Start over. Expected: ${this.currentApplicationDataUnit.lengthEncryptedPayload}. Received: ${this.currentApplicationDataUnit.encryptedPayload.length}`),console.log(JSON.stringify(this.currentApplicationDataUnit)),this.resetSearch())):this.currentSequenceNumber++}else console.log(`addTelegrams: Sequence number does not match. Start over. Expected: ${this.currentSequenceNumber}. Received: ${t.sequenceNumber}`),this.resetSearch();return this.areApplicationDataUnitsAvailable()}getApplicationDataUnits(){const e=[...this.applicationDataUnits];return this.applicationDataUnits=[],e}resetSearch(){this.currentSequenceNumber=0,this.currentApplicationDataUnit=new a.ApplicationProtocolDataUnit,this.currentApplicationDataUnits=[]}}t.MultiTelegramReader=s,s.CypheringServiceGeneralGloCiphering=219},794:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiveBuffer=void 0,t.ReceiveBuffer=class{constructor(e,t=8192){this.initialSize=e,this.maxSize=t,this._length=0,this.buffer=Buffer.allocUnsafe(e)}get length(){return this._length}reset(){this._length=0}addBuffer(e,t=0){const r=e.length-t+this._length;if(r>this.buffer.length){if(r>this.maxSize)return console.error(`ReceiveBuffer.addBuffer overflow. Buffer size: ${this.buffer.length}. Max size: ${this.maxSize}. Current length: ${this._length}. New data length: ${e.length-t}`),!1;if(this.buffer.length<this.maxSize){console.warn(`ReceiveBuffer.addBuffer overflow. Buffer size: ${this.buffer.length}. Current length: ${this._length}. New data length: ${e.length-t}. Size increased to ${this.maxSize}`);const r=Buffer.allocUnsafe(this.maxSize);this._length>0&&this.buffer.copy(r,0,0,this._length),this.buffer=r}}return e.copy(this.buffer,this._length,t),this._length=r,!0}checkForNewStartIndex(e){const t=this.buffer.indexOf(e,1);return t<1?(this._length=0,!1):(this.buffer.copy(this.buffer,0,t),this._length-=t,!0)}asNumberArray(){const e=new Array(this._length);for(let t=0;t<this._length;t++)e[t]=this.buffer[t];return e}}},145:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TelegramReader=void 0;const i=r(82),a=r(745),n=r(794);class s{constructor(){this.currentTelegram=new a.Telegram,this.possibleStartFound=!1,this.receiveBuffer=new n.ReceiveBuffer(s.receiveBufferInitialSize,s.receiveBufferMaxSize),this.telegrams=[]}areTelegramsAvailable(){return this.telegrams.length>0?i.TelegramState.available:i.TelegramState.pending}resetSearch(){this.possibleStartFound=!1,this.currentTelegram=new a.Telegram}addRawData(e){let t=0;if(!this.possibleStartFound){if(t=e.indexOf(s.startByte),t<0)return this.areTelegramsAvailable();this.possibleStartFound=!0}return this.receiveBuffer.addBuffer(e,t)||this.receiveBuffer.reset(),this.checkTelegram()}getTelegrams(){const e=[...this.telegrams];return this.telegrams=[],e}checkTelegram(){if(this.receiveBuffer.length<4)return this.areTelegramsAvailable();if(this.currentTelegram.lengthData<=0){if(this.receiveBuffer.buffer[3]!=s.startByte||this.receiveBuffer.buffer[1]!=this.receiveBuffer.buffer[2])return this.checkForNewStartIndex();this.currentTelegram.lengthData=this.receiveBuffer.buffer[1]}if(this.currentTelegram.lengthData<=3)return this.checkForNewStartIndex();if(this.receiveBuffer.length<this.currentTelegram.lengthTotal)return this.areTelegramsAvailable();if(this.receiveBuffer.buffer[this.currentTelegram.lengthTotal-1]!=s.stopByte)return this.checkForNewStartIndex();const e=this.checkChecksum();if(this.currentTelegram.checkSum=this.receiveBuffer.buffer[this.currentTelegram.lengthTotal-2],e!=this.currentTelegram.checkSum)return console.warn("Invalid checksum",e,this.currentTelegram.checkSum),this.checkForNewStartIndex();this.currentTelegram.controlField=this.receiveBuffer.buffer[4],this.currentTelegram.addressField=this.receiveBuffer.buffer[5],this.currentTelegram.controlInformationField=this.receiveBuffer.buffer[6],this.currentTelegram.sourceAddress=this.receiveBuffer.buffer[7],this.currentTelegram.destinationAddress=this.receiveBuffer.buffer[8],this.currentTelegram.applicationData=this.receiveBuffer.buffer.subarray(9,this.currentTelegram.lengthTotal-2),this.telegrams.push(this.currentTelegram);const t=this.currentTelegram.lengthTotal;if(this.resetSearch(),this.receiveBuffer.length<=t)return this.receiveBuffer=new n.ReceiveBuffer(s.receiveBufferInitialSize,s.receiveBufferMaxSize),i.TelegramState.available;const r=this.receiveBuffer;return this.receiveBuffer=new n.ReceiveBuffer(s.receiveBufferInitialSize,s.receiveBufferMaxSize),this.receiveBuffer.addBuffer(r.buffer.subarray(0,r.length),t),this.checkTelegram()}checkForNewStartIndex(){return this.resetSearch(),this.receiveBuffer.checkForNewStartIndex(s.startByte)?(this.possibleStartFound=!0,this.checkTelegram()):this.areTelegramsAvailable()}checkChecksum(){const e=this.currentTelegram.lengthTotal-2;let t=0;for(let r=4;r<e;r++)t+=this.receiveBuffer.buffer[r];return 255&t}}t.TelegramReader=s,s.startByte=104,s.stopByte=22,s.receiveBufferInitialSize=512,s.receiveBufferMaxSize=8192},745:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Telegram=void 0,t.Telegram=class{constructor(){this._lengthData=0,this._lengthTotal=0,this._lengthTransportData=0,this._lengthApplicationData=0,this.checkSum=-1,this.controlField=0,this.addressField=0,this._controlInformationField=0,this._sequenceNumber=0,this._isLastSegment=!0,this.sourceAddress=0,this.destinationAddress=0}set lengthData(e){this._lengthData=e,this._lengthTotal=e+6,this._lengthTransportData=e-2,this._lengthApplicationData=e-5}get lengthData(){return this._lengthData}get lengthTotal(){return this._lengthTotal}get lengthTransportData(){return this._lengthTransportData}get lengthApplicationData(){return this._lengthApplicationData}set controlInformationField(e){this._controlInformationField=e,this._sequenceNumber=15&this._controlInformationField,this._isLastSegment=16==(16&this._controlInformationField)}get controlInformationField(){return this._controlInformationField}get sequenceNumber(){return this._sequenceNumber}get isLastSegment(){return this._isLastSegment}}},97:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Tools=void 0,t.Tools=class{static getStringFromByteArray(e){return String.fromCharCode(...e)}static getNumberFromByteArray(e){let t=0;for(let r=e.length-1,i=1;r>=0;r--)t+=e[r]*i,i*=256;return t}static getByteArrayFromHexString(e){e=e.replace(/\s+/g,"");let t=[];for(let r=0;r<e.length;r+=2)t.push(parseInt(e.substring(r,r+2),16));return t}static getHexStringFromByteArray(e,t=!1){let r=[];for(let t=0;t<e.length;t++){const i=e[t]<0?e[t]+256:e[t];r.push((i>>>4).toString(16)),r.push((15&i).toString(16))}return r.join(t?" ":"")}static getNumberFromBuffer(e,t=0,r){null==r&&(r=e.length);let i=0;for(let a=r-1,n=1;a>=t;a--)i+=e[a]*n,n*=256;return i}}},605:e=>{e.exports=require("serialport")},113:e=>{e.exports=require("crypto")}},t={};function r(i){var a=t[i];if(void 0!==a)return a.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,r),n.exports}var i={};for(var a in(()=>{var e=i;Object.defineProperty(e,"__esModule",{value:!0});const t=r(605),a=r(145),n=r(82),s=r(222);!function(){const e=new t.SerialPort({path:"/dev/serial/by-id/usb-Prolific_Technology_Inc._USB-Serial_Controller_DIDSt114J20-if00-port0",baudRate:2400,dataBits:8,parity:"none",stopBits:1}),r=new a.TelegramReader,i=new s.MultiTelegramReader(r);e.on("data",(function(e){if(r.addRawData(e)==n.TelegramState.available){const e=r.getTelegrams();if(console.log(JSON.stringify(e)),i.addTelegrams(e)==n.ApplicationDataState.available){const e=i.getApplicationDataUnits();console.log(JSON.stringify(e))}}})),e.on("error",(function(e){console.error("Error: ",e.message)}))}()})(),i)this[a]=i[a];i.__esModule&&Object.defineProperty(this,"__esModule",{value:!0})})();
//# sourceMappingURL=index.js.map