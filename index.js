(()=>{"use strict";var e={91:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return a(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationDataDecrypter=void 0;const s=n(r(113)),l=r(312);t.ApplicationDataDecrypter=class{static Decrypt(e){const t=Buffer.from(l.DecryptionSettings.key,"hex"),r=Buffer.concat([e.systemTitle,e.frameCounter]),i=Buffer.concat([r,Buffer.from("00000002","hex")]);let a=s.createDecipheriv("aes-128-ctr",t,i);const n=a.update(e.encryptedPayload),o=a.final();e.decryptedPayload=Buffer.concat([n,o])}}},535:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationProtocolDataUnit=void 0;const i=r(82),a=r(97);t.ApplicationProtocolDataUnit=class{setSystemTitle(e){if(this._systemTitle=e,this._systemTitleManufacturerId=e.subarray(0,3).toString(),this._serialNumber=a.Tools.getNumberFromBuffer(e,5,8),"KFM"==this._systemTitleManufacturerId){let t=e[3].toString(16).padStart(2,"0"),r=e[4].toString(16).padStart(2,"0"),i=a.Tools.getNumberFromBuffer(e,5,8).toString().padStart(7,"0");this._systemTitleText=t[0]+this._systemTitleManufacturerId+t[1]+r+i}else{let t=0;for(;t<5&&e[3+t]>=48&&e[3+t]<=122;)t++;let r="",i="";if(t>0&&(r=e.subarray(3,3+t).toString()),3+t<8){let r=(256**(5-t)).toString().length;i=a.Tools.getNumberFromByteArray([...e.subarray(3+t,8)]).toString().padStart(r,"0")}this._systemTitleText=this._systemTitleManufacturerId+r+i}}get systemTitle(){return this._systemTitle}get systemTitleManufacturerId(){return this._systemTitleManufacturerId}get systemTitleText(){return this._systemTitleText}setLength(e,t=0,r){return null==r&&(r=e.length),130==e[t]?(this._lengthField=a.Tools.getNumberFromBuffer(e,t+1,r),this._lengthFieldLength=3):(this._lengthField=e[t],this._lengthFieldLength=1),this._lengthEncryptedPayload=this._lengthField-5,this._lengthTotal=this._lengthField+this._lengthFieldLength+10,this._lengthFieldLength}get lengthFieldLength(){return this._lengthFieldLength}get lengthTotal(){return this._lengthTotal}get lengthEncryptedPayload(){return this._lengthEncryptedPayload}get lengthField(){return this._lengthField}set securityControl(e){this._securityControl=e,this._securitySuiteId=15&this._securityControl,this._securityAuthentication=16==(16&this._securityControl),this._securityEncryption=32==(32&this._securityControl),this._securityKeySet=64==(64&this._securityControl)?i.KeySet.broadcast:i.KeySet.unicast,this._securityCompression=128==(128&this._securityControl)}get securityControl(){return this._securityControl}get securitySuiteId(){return this._securitySuiteId}get securityAuthentication(){return this._securityAuthentication}get securityEncryption(){return this._securityEncryption}get securityKeySet(){return this._securityKeySet}get securityCompression(){return this._securityCompression}setFrameCounter(e,t=0,r){this._frameCounter=e.subarray(t,r),this._frameCounterNumber=a.Tools.getNumberFromBuffer(this._frameCounter)}get frameCounter(){return this._frameCounter}get frameCounterNumber(){return this._frameCounterNumber}}},82:(e,t)=>{var r,i,a,n;Object.defineProperty(t,"__esModule",{value:!0}),t.KeySet=t.ApplicationDataProvisioning=t.ApplicationDataState=t.TelegramState=void 0,(n=t.TelegramState||(t.TelegramState={}))[n.pending=0]="pending",n[n.available=1]="available",(a=t.ApplicationDataState||(t.ApplicationDataState={}))[a.pending=0]="pending",a[a.available=1]="available",(i=t.ApplicationDataProvisioning||(t.ApplicationDataProvisioning={}))[i.lastOnly=0]="lastOnly",i[i.all=1]="all",(r=t.KeySet||(t.KeySet={}))[r.unicast=0]="unicast",r[r.broadcast=1]="broadcast"},222:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MultiTelegramReader=void 0;const i=r(82),a=r(535),n=r(91);class s{constructor(e,t=i.ApplicationDataProvisioning.all){this.telegramReader=e,this.provisioning=t,this.applicationDataUnits=[],this.currentApplicationDataUnit=new a.ApplicationProtocolDataUnit,this.currentApplicationDataUnits=[],this.currentSequenceNumber=0}areApplicationDataUnitsAvailable(){return this.applicationDataUnits.length>0?i.ApplicationDataState.available:i.ApplicationDataState.pending}addRawData(e){if(this.telegramReader.addRawData(e)==i.TelegramState.available){const e=this.telegramReader.getTelegrams();return this.addTelegrams(e)}return this.areApplicationDataUnitsAvailable()}addTelegrams(e){for(let t of e)if(t.sequenceNumber==this.currentSequenceNumber){if(0===t.sequenceNumber){if(t.applicationData.length<17){console.warn(`addTelegrams: Application data length of first telegram in sequence invalid. Start over. Expected: >= 17. Received: ${t.applicationData.length}`),this.resetSearch();continue}if(this.currentApplicationDataUnit.cypheringService=t.applicationData[0],this.currentApplicationDataUnit.cypheringService!=s.cypheringServiceGeneralGloCiphering){console.warn(`addTelegrams: Application data cyphering service invalid. Start over. Expected: ${s.cypheringServiceGeneralGloCiphering.toString(16)}. Received: ${this.currentApplicationDataUnit.cypheringService.toString(16)}`),this.resetSearch();continue}this.currentApplicationDataUnit.setSystemTitle(t.applicationData.subarray(2,10));const e=this.currentApplicationDataUnit.setLength(t.applicationData,10,13)-1;this.currentApplicationDataUnit.securityControl=t.applicationData[11+e],this.currentApplicationDataUnit.setFrameCounter(t.applicationData,12+e,16+e)}this.currentApplicationDataUnits.push(t.applicationData),t.isLastSegment?(this.currentApplicationDataUnit.apduRaw=Buffer.concat(this.currentApplicationDataUnits),this.currentApplicationDataUnit.encryptedPayload=this.currentApplicationDataUnit.apduRaw.subarray(16+this.currentApplicationDataUnit.lengthFieldLength-1),n.ApplicationDataDecrypter.Decrypt(this.currentApplicationDataUnit),this.currentApplicationDataUnit.lengthEncryptedPayload==this.currentApplicationDataUnit.encryptedPayload.length?(this.provisioning==i.ApplicationDataProvisioning.all?this.applicationDataUnits.push(this.currentApplicationDataUnit):this.applicationDataUnits=[this.currentApplicationDataUnit],this.resetSearch()):(console.warn(`addTelegrams: Application data length of combined segments invalid. Start over. Expected: ${this.currentApplicationDataUnit.lengthEncryptedPayload}. Received: ${this.currentApplicationDataUnit.encryptedPayload.length}`),this.resetSearch())):this.currentSequenceNumber++}else console.log(`addTelegrams: Sequence number does not match. Start over. Expected: ${this.currentSequenceNumber}. Received: ${t.sequenceNumber}`),this.resetSearch();return this.areApplicationDataUnitsAvailable()}getApplicationDataUnits(){const e=[...this.applicationDataUnits];return this.applicationDataUnits=[],e}resetSearch(){this.currentSequenceNumber=0,this.currentApplicationDataUnit=new a.ApplicationProtocolDataUnit,this.currentApplicationDataUnits=[]}}t.MultiTelegramReader=s,s.cypheringServiceGeneralGloCiphering=219},794:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiveBuffer=void 0,t.ReceiveBuffer=class{constructor(e,t=8192){this.initialSize=e,this.maxSize=t,this._length=0,this.buffer=Buffer.allocUnsafe(e)}get length(){return this._length}reset(){this._length=0}addBuffer(e,t=0){const r=e.length-t+this._length;if(r>this.buffer.length){if(r>this.maxSize)return console.error(`ReceiveBuffer.addBuffer overflow. Buffer size: ${this.buffer.length}. Max size: ${this.maxSize}. Current length: ${this._length}. New data length: ${e.length-t}`),!1;if(this.buffer.length<this.maxSize){console.warn(`ReceiveBuffer.addBuffer overflow. Buffer size: ${this.buffer.length}. Current length: ${this._length}. New data length: ${e.length-t}. Size increased to ${this.maxSize}`);const r=Buffer.allocUnsafe(this.maxSize);this._length>0&&this.buffer.copy(r,0,0,this._length),this.buffer=r}}return e.copy(this.buffer,this._length,t),this._length=r,!0}checkForNewStartIndex(e){const t=this.buffer.indexOf(e,1);return t<1?(this._length=0,!1):(this.buffer.copy(this.buffer,0,t),this._length-=t,!0)}asNumberArray(){const e=new Array(this._length);for(let t=0;t<this._length;t++)e[t]=this.buffer[t];return e}}},312:function(e,t,r){var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return a(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Settings=t.DebugSettings=t.DecodingSettings=t.DecryptionSettings=t.SerialPortSettings=void 0;const s=n(r(771));class l{static read(){l.port=s.get("serialPort.port"),l.baudRate=s.get("serialPort.baudRate"),l.dataBits=s.get("serialPort.dataBits"),l.parity=s.get("serialPort.parity"),l.stopBits=s.get("serialPort.stopBits")}}t.SerialPortSettings=l,l.port="",l.baudRate=2400,l.dataBits=8,l.parity="none",l.stopBits=1;class o{static read(){o.key=s.get("decryption.key")}}t.DecryptionSettings=o,o.key="";class c{static read(){c.language=s.get("decoding.language")}}t.DecodingSettings=c,c.language="en";class u{static read(){u.maxBytes=s.get("debug.maxBytes"),u.maxTelegrams=s.get("debug.maxTelegrams"),u.maxApplicationDataUnits=s.get("debug.maxApplicationDataUnits"),u.logSerialPort=s.get("debug.logSerialPort"),u.logSerialPortMinBytes=s.get("Debug.logSerialPortMinBytes"),u.logTelegramRaw=s.get("debug.logTelegramRaw"),u.logTelegramJson=s.get("debug.logTelegramJson"),u.logApduRaw=s.get("debug.logApduRaw"),u.logApduJson=s.get("debug.logApduJson"),u.logApduDecryptedRaw=s.get("debug.logApduDecryptedRaw"),u.logApduDecryptedJson=s.get("debug.logApduDecryptedJson"),u.logApduDecryptedXml=s.get("debug.logApduDecryptedXml"),u.logApduDecryptedValuesJson=s.get("debug.logApduDecryptedValuesJson")}}t.DebugSettings=u,u.maxBytes=0,u.maxTelegrams=0,u.maxApplicationDataUnits=0;class g{static read(){l.read(),o.read(),c.read(),u.read()}}t.Settings=g,g.serialPort=l,g.decryption=o,g.decoding=c,g.debug=u},145:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TelegramReader=void 0;const i=r(82),a=r(745),n=r(794);class s{constructor(){this.currentTelegram=new a.Telegram,this.possibleStartFound=!1,this.receiveBuffer=new n.ReceiveBuffer(s.receiveBufferInitialSize,s.receiveBufferMaxSize),this.telegrams=[]}areTelegramsAvailable(){return this.telegrams.length>0?i.TelegramState.available:i.TelegramState.pending}addRawData(e){let t=0;if(!this.possibleStartFound){if(t=e.indexOf(s.startByte),t<0)return this.areTelegramsAvailable();this.possibleStartFound=!0}return this.receiveBuffer.addBuffer(e,t)?this.checkTelegram():(this.receiveBuffer.reset(),this.areTelegramsAvailable())}getTelegrams(){const e=[...this.telegrams];return this.telegrams=[],e}resetSearch(){this.possibleStartFound=!1,this.currentTelegram=new a.Telegram}checkTelegram(){if(this.receiveBuffer.length<4)return this.areTelegramsAvailable();if(this.currentTelegram.lengthData<=0){if(this.receiveBuffer.buffer[3]!=s.startByte||this.receiveBuffer.buffer[1]!=this.receiveBuffer.buffer[2])return this.checkForNewStartIndex();this.currentTelegram.lengthData=this.receiveBuffer.buffer[1]}if(this.currentTelegram.lengthData<=3)return this.checkForNewStartIndex();if(this.receiveBuffer.length<this.currentTelegram.lengthTotal)return this.areTelegramsAvailable();if(this.receiveBuffer.buffer[this.currentTelegram.lengthTotal-1]!=s.stopByte)return this.checkForNewStartIndex();const e=this.checkChecksum();if(this.currentTelegram.checkSum=this.receiveBuffer.buffer[this.currentTelegram.lengthTotal-2],e!=this.currentTelegram.checkSum)return console.warn("Invalid checksum",e,this.currentTelegram.checkSum),this.checkForNewStartIndex();this.currentTelegram.telegramRaw=this.receiveBuffer.buffer.subarray(0,this.currentTelegram.lengthTotal),this.currentTelegram.controlField=this.receiveBuffer.buffer[4],this.currentTelegram.addressField=this.receiveBuffer.buffer[5],this.currentTelegram.controlInformationField=this.receiveBuffer.buffer[6],this.currentTelegram.sourceAddress=this.receiveBuffer.buffer[7],this.currentTelegram.destinationAddress=this.receiveBuffer.buffer[8],this.currentTelegram.applicationData=this.receiveBuffer.buffer.subarray(9,this.currentTelegram.lengthTotal-2),this.telegrams.push(this.currentTelegram);const t=this.currentTelegram.lengthTotal;if(this.resetSearch(),this.receiveBuffer.length<=t)return this.receiveBuffer=new n.ReceiveBuffer(s.receiveBufferInitialSize,s.receiveBufferMaxSize),i.TelegramState.available;const r=this.receiveBuffer;return this.receiveBuffer=new n.ReceiveBuffer(s.receiveBufferInitialSize,s.receiveBufferMaxSize),this.receiveBuffer.addBuffer(r.buffer.subarray(0,r.length),t),this.checkTelegram()}checkForNewStartIndex(){return this.resetSearch(),this.receiveBuffer.checkForNewStartIndex(s.startByte)?(this.possibleStartFound=!0,this.checkTelegram()):this.areTelegramsAvailable()}checkChecksum(){const e=this.currentTelegram.lengthTotal-2;let t=0;for(let r=4;r<e;r++)t+=this.receiveBuffer.buffer[r];return 255&t}}t.TelegramReader=s,s.startByte=104,s.stopByte=22,s.receiveBufferInitialSize=512,s.receiveBufferMaxSize=8192},745:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Telegram=void 0,t.Telegram=class{constructor(){this._lengthData=0,this._lengthTotal=0,this._lengthTransportData=0,this._lengthApplicationData=0,this.checkSum=-1,this.controlField=0,this.addressField=0,this._controlInformationField=0,this._sequenceNumber=0,this._isLastSegment=!0,this.sourceAddress=0,this.destinationAddress=0}set lengthData(e){this._lengthData=e,this._lengthTotal=e+6,this._lengthTransportData=e-2,this._lengthApplicationData=e-5}get lengthData(){return this._lengthData}get lengthTotal(){return this._lengthTotal}get lengthTransportData(){return this._lengthTransportData}get lengthApplicationData(){return this._lengthApplicationData}set controlInformationField(e){this._controlInformationField=e,this._sequenceNumber=15&this._controlInformationField,this._isLastSegment=16==(16&this._controlInformationField)}get controlInformationField(){return this._controlInformationField}get sequenceNumber(){return this._sequenceNumber}get isLastSegment(){return this._isLastSegment}}},97:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Tools=void 0,t.Tools=class{static getStringFromByteArray(e){return String.fromCharCode(...e)}static getNumberFromByteArray(e){let t=0;for(let r=e.length-1,i=1;r>=0;r--)t+=e[r]*i,i*=256;return t}static getByteArrayFromHexString(e){e=e.replace(/\s+/g,"");let t=[];for(let r=0;r<e.length;r+=2)t.push(parseInt(e.substring(r,r+2),16));return t}static getHexStringFromByteArray(e,t=!1){let r=[];for(let t=0;t<e.length;t++){const i=e[t]<0?e[t]+256:e[t];r.push((i>>>4).toString(16)),r.push((15&i).toString(16))}return r.join(t?" ":"")}static getNumberFromBuffer(e,t=0,r){null==r&&(r=e.length);let i=0;for(let a=r-1,n=1;a>=t;a--)i+=e[a]*n,n*=256;return i}}},771:e=>{e.exports=require("config")},605:e=>{e.exports=require("serialport")},113:e=>{e.exports=require("crypto")}},t={};function r(i){var a=t[i];if(void 0!==a)return a.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,r),n.exports}var i={};for(var a in(()=>{var e=i;Object.defineProperty(e,"__esModule",{value:!0});const t=r(605),a=r(145),n=r(82),s=r(222),l=r(312);let o,c=[],u=0,g=0,h=0,p=0,f=!1;!function(){l.Settings.read(),f=l.DebugSettings.maxBytes>0||l.DebugSettings.maxTelegrams>0||l.DebugSettings.maxApplicationDataUnits>0,o=new t.SerialPort({path:l.SerialPortSettings.port,baudRate:l.SerialPortSettings.baudRate,dataBits:l.SerialPortSettings.dataBits,parity:l.SerialPortSettings.parity,stopBits:l.SerialPortSettings.stopBits});const e=new a.TelegramReader,r=new s.MultiTelegramReader(e);o.on("data",(function(t){if(l.DebugSettings.logSerialPort&&function(e){l.DebugSettings.logSerialPortMinBytes<=1||0==u&&e.length>=l.DebugSettings.logSerialPortMinBytes?console.log(e.toString("hex")):(c.push(e),u+=e.length,u<l.DebugSettings.logSerialPortMinBytes||(console.log(Buffer.concat(c).toString("hex")),c=[],u=0))}(t),g+=t.length,e.addRawData(t)==n.TelegramState.available){const t=e.getTelegrams();if(h+=t.length,function(e){l.DebugSettings.logTelegramRaw&&e.forEach((e=>console.log("Telegram: ",e.telegramRaw.toString("hex")))),l.DebugSettings.logTelegramJson&&e.forEach((e=>console.log("Telegram: ",e)))}(t),r.addTelegrams(t)==n.ApplicationDataState.available){const e=r.getApplicationDataUnits();p+=e.length,function(e){l.DebugSettings.logApduRaw&&e.forEach((e=>console.log("APDU: ",e.apduRaw.toString("hex")))),l.DebugSettings.logApduJson&&e.forEach((e=>console.log("APDU: ",e))),l.DebugSettings.logApduDecryptedRaw&&e.forEach((e=>console.log("APDU payload decrypted: ",e.decryptedPayload.toString("hex"))))}(e)}}f&&((0==l.DebugSettings.maxBytes||g<l.DebugSettings.maxBytes)&&(0==l.DebugSettings.maxTelegrams||h<l.DebugSettings.maxTelegrams)&&(0==l.DebugSettings.maxApplicationDataUnits||p<l.DebugSettings.maxApplicationDataUnits)||(l.DebugSettings.logSerialPort&&l.DebugSettings.logSerialPortMinBytes>1&&u>0&&console.log(Buffer.concat(c).toString("hex")),o.close((e=>{e&&console.error(e),process.exit(1)})),console.log(`Stopping because of Debug config: maxBytes (${l.DebugSettings.maxBytes}), maxTelegrams (${l.DebugSettings.maxTelegrams}) or maxApplicationDataUnits (${l.DebugSettings.maxApplicationDataUnits}) > 0 ...`)))})),o.on("error",(function(e){console.error("Serial port error: ",e.message)}))}()})(),i)this[a]=i[a];i.__esModule&&Object.defineProperty(this,"__esModule",{value:!0})})();
//# sourceMappingURL=index.js.map