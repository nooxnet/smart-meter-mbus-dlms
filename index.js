(()=>{"use strict";var t={535:(t,e,a)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ApplicationProtocolDataUnit=void 0;const i=a(82),r=a(97);e.ApplicationProtocolDataUnit=class{constructor(){this.encryptedPayload=[]}setSystemTitle(t){if(this._systemTitle=t,this._systemTitleManufacturerId=r.Tools.getStringFromByteArray(t.slice(0,3)),"KFM"==this._systemTitleManufacturerId){let e=t[3].toString(16).padStart(2,"0"),a=t[4].toString(16).padStart(2,"0"),i=r.Tools.getNumberFromByteArray(t.slice(5,8)).toString().padStart(7,"0");this._serialNumber=e[0]+this._systemTitleManufacturerId+e[1]+a+i}else{let e=0;for(;e<5&&t[3+e]>=48&&t[3+e]<=122;)e++;let a="",i="";if(e>0&&(a=r.Tools.getStringFromByteArray(t.slice(3,3+e))),3+e<8){let a=Math.pow(256,5-e).toString().length;i=r.Tools.getNumberFromByteArray(t.slice(3+e,8)).toString().padStart(a,"0")}this._serialNumber=this._systemTitleManufacturerId+a+i}}get systemTitle(){return this._systemTitle}get systemTitleManufacturerId(){return this._systemTitleManufacturerId}setLength(t){return 130==t[0]?(this._lengthField=r.Tools.getNumberFromByteArray(t.slice(1)),this._lengthFieldLength=3):(this._lengthField=t[0],this._lengthFieldLength=1),this._lengthEncryptedPayload=this._lengthField-5,this._lengthTotal=this._lengthField+this._lengthFieldLength+10,this._lengthFieldLength}get lengthFieldLength(){return this._lengthFieldLength}get lengthTotal(){return this._lengthTotal}get lengthEncryptedPayload(){return this._lengthEncryptedPayload}get lengthField(){return this._lengthField}set securityControl(t){this._securityControl=t,this._securitySuiteId=15&this._securityControl,this._securityAuthentication=16==(16&this._securityControl),this._securityEncryption=32==(32&this._securityControl),this._securityKeySet=64==(64&this._securityControl)?i.KeySet.broadcast:i.KeySet.unicast,this._securityCompression=128==(128&this._securityControl)}get securityControl(){return this._securityControl}get securitySuiteId(){return this._securitySuiteId}get securityAuthentication(){return this._securityAuthentication}get securityEncryption(){return this._securityEncryption}get securityKeySet(){return this._securityKeySet}get securityCompression(){return this._securityCompression}setFrameCounter(t){this._frameCounter=r.Tools.getNumberFromByteArray(t)}get frameCounter(){return this._frameCounter}}},82:(t,e)=>{var a,i,r,n;Object.defineProperty(e,"__esModule",{value:!0}),e.KeySet=e.ApplicationDataProvisioning=e.ApplicationDataState=e.TelegramState=void 0,(n=e.TelegramState||(e.TelegramState={}))[n.pending=0]="pending",n[n.available=1]="available",(r=e.ApplicationDataState||(e.ApplicationDataState={}))[r.pending=0]="pending",r[r.available=1]="available",(i=e.ApplicationDataProvisioning||(e.ApplicationDataProvisioning={}))[i.lastOnly=0]="lastOnly",i[i.all=1]="all",(a=e.KeySet||(e.KeySet={}))[a.unicast=0]="unicast",a[a.broadcast=1]="broadcast"},222:(t,e,a)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.MultiTelegramReader=void 0;const i=a(82),r=a(535);class n{constructor(t,e=i.ApplicationDataProvisioning.lastOnly){this.telegramReader=t,this.provisioning=e,this.applicationDataUnits=[],this.currentApplicationDataUnit=new r.ApplicationProtocolDataUnit,this.currentSequenceNumber=0}areApplicationDataUnitsAvailable(){return this.applicationDataUnits.length>0?i.ApplicationDataState.available:i.ApplicationDataState.pending}addRawData(t){if(this.telegramReader.addRawData(t)==i.TelegramState.available){const t=this.telegramReader.getTelegrams();return this.addTelegrams(t)}return this.areApplicationDataUnitsAvailable()}addTelegrams(t){for(let e of t)if(e.sequenceNumber==this.currentSequenceNumber){if(0===e.sequenceNumber){if(e.applicationData.length<17){console.warn(`addTelegrams: Application data length of first telegram in sequence invalid. Start over. Expected: >= 17. Received: ${e.applicationData.length}`),this.resetSearch();continue}if(this.currentApplicationDataUnit.cypheringService=e.applicationData[0],this.currentApplicationDataUnit.cypheringService!=n.CypheringServiceGeneralGloCiphering){console.warn(`addTelegrams: Application data cyphering service invalid. Start over. Expected: ${n.CypheringServiceGeneralGloCiphering.toString(16)}. Received: ${this.currentApplicationDataUnit.cypheringService.toString(16)}`),this.resetSearch();continue}this.currentApplicationDataUnit.setSystemTitle(e.applicationData.slice(2,10));const t=this.currentApplicationDataUnit.setLength(e.applicationData.slice(10,13))-1;this.currentApplicationDataUnit.securityControl=e.applicationData[11+t],this.currentApplicationDataUnit.setFrameCounter(e.applicationData.slice(12+t,16+t)),this.currentApplicationDataUnit.encryptedPayload=e.applicationData.slice(16+t)}else this.currentApplicationDataUnit.encryptedPayload.push(...e.applicationData);e.isLastSegment?this.currentApplicationDataUnit.lengthEncryptedPayload==this.currentApplicationDataUnit.encryptedPayload.length?(this.provisioning==i.ApplicationDataProvisioning.all?this.applicationDataUnits.push(this.currentApplicationDataUnit):this.applicationDataUnits=[this.currentApplicationDataUnit],this.resetSearch()):(console.warn(`addTelegrams: Application data length of combined segments invalid. Start over. Expected: ${this.currentApplicationDataUnit.lengthEncryptedPayload}. Received: ${this.currentApplicationDataUnit.encryptedPayload.length}`),console.log(JSON.stringify(this.currentApplicationDataUnit)),this.resetSearch()):this.currentSequenceNumber++}else console.log(`addTelegrams: Sequence number does not match. Start over. Expected: ${this.currentSequenceNumber}. Received: ${e.sequenceNumber}`),this.resetSearch();return this.areApplicationDataUnitsAvailable()}getApplicationDataUnits(){const t=[...this.applicationDataUnits];return this.applicationDataUnits=[],t}resetSearch(){this.currentSequenceNumber=0,this.currentApplicationDataUnit=new r.ApplicationProtocolDataUnit}}e.MultiTelegramReader=n,n.CypheringServiceGeneralGloCiphering=219},145:(t,e,a)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.TelegramReader=void 0;const i=a(82),r=a(745);class n{constructor(){this.currentTelegram=new r.Telegram,this.possibleStartFound=!1,this.data=[],this.telegrams=[]}areTelegramsAvailable(){return this.telegrams.length>0?i.TelegramState.available:i.TelegramState.pending}resetSearch(){this.possibleStartFound=!1,this.currentTelegram=new r.Telegram}addRawData(t){if(!this.possibleStartFound){const e=t.indexOf(n.startByte);if(e<0)return this.areTelegramsAvailable();this.possibleStartFound=!0,e>0&&(t=t.slice(e))}return this.data.push(...t),this.checkTelegram()}getTelegrams(){const t=[...this.telegrams];return this.telegrams=[],t}checkTelegram(){if(this.data.length<4)return this.areTelegramsAvailable();if(this.currentTelegram.lengthData<=0){if(this.data[3]!=n.startByte||this.data[1]!=this.data[2])return this.checkForNewStartIndex(1);this.currentTelegram.lengthData=this.data[1]}if(this.currentTelegram.lengthData<=3)return this.checkForNewStartIndex(1);if(this.data.length<this.currentTelegram.lengthTotal)return this.areTelegramsAvailable();if(this.data[this.currentTelegram.lengthTotal-1]!=n.stopByte)return this.checkForNewStartIndex(1);const t=this.checkChecksum();if(this.currentTelegram.checkSum=this.data[this.currentTelegram.lengthTotal-2],t!=this.currentTelegram.checkSum)return console.warn("Invalid checksum",t,this.currentTelegram.checkSum),this.checkForNewStartIndex(1);this.currentTelegram.controlField=this.data[4],this.currentTelegram.addressField=this.data[5],this.currentTelegram.controlInformationField=this.data[6],this.currentTelegram.sourceAddress=this.data[7],this.currentTelegram.destinationAddress=this.data[8],this.currentTelegram.applicationData=this.data.slice(9,this.currentTelegram.lengthTotal-2),this.telegrams.push(this.currentTelegram);const e=this.currentTelegram.lengthTotal;return this.resetSearch(),this.data.length>e?(this.data=this.data.slice(e),this.checkTelegram()):(this.data=[],i.TelegramState.available)}checkForNewStartIndex(t){this.resetSearch();const e=this.data.indexOf(n.startByte,t);return e<t?(this.data=[],this.areTelegramsAvailable()):(this.data=this.data.slice(e),this.possibleStartFound=!0,this.checkTelegram())}checkChecksum(){const t=this.currentTelegram.lengthTotal-2;let e=0;for(let a=4;a<t;a++)e+=this.data[a];return 255&e}}e.TelegramReader=n,n.startByte=104,n.stopByte=22},745:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Telegram=void 0,e.Telegram=class{constructor(){this._lengthData=0,this._lengthTotal=0,this._lengthTransportData=0,this._lengthApplicationData=0,this.checkSum=-1,this.controlField=0,this.addressField=0,this._controlInformationField=0,this._sequenceNumber=0,this._isLastSegment=!0,this.sourceAddress=0,this.destinationAddress=0,this.applicationData=[]}set lengthData(t){this._lengthData=t,this._lengthTotal=t+6,this._lengthTransportData=t-2,this._lengthApplicationData=t-5}get lengthData(){return this._lengthData}get lengthTotal(){return this._lengthTotal}get lengthTransportData(){return this._lengthTransportData}get lengthApplicationData(){return this._lengthApplicationData}set controlInformationField(t){this._controlInformationField=t,this._sequenceNumber=15&this._controlInformationField,this._isLastSegment=16==(16&this._controlInformationField)}get controlInformationField(){return this._controlInformationField}get sequenceNumber(){return this._sequenceNumber}get isLastSegment(){return this._isLastSegment}}},97:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Tools=void 0,e.Tools=class{static getStringFromByteArray(t){return String.fromCharCode(...t)}static getNumberFromByteArray(t){let e=0;for(let a=t.length-1,i=1;a>=0;a--)e+=t[a]*i,i*=256;return e}static getByteArrayFromHexString(t){t=t.replace(/\s+/g,"");let e=[];for(let a=0;a<t.length;a+=2)e.push(parseInt(t.substring(a,a+2),16));return e}static getHexStringFromByteArray(t,e=!1){let a=[];for(let e=0;e<t.length;e++){const i=t[e]<0?t[e]+256:t[e];a.push((i>>>4).toString(16)),a.push((15&i).toString(16))}return a.join(e?" ":"")}}},605:t=>{t.exports=require("serialport")}},e={};function a(i){var r=e[i];if(void 0!==r)return r.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,a),n.exports}var i={};for(var r in(()=>{var t=i;Object.defineProperty(t,"__esModule",{value:!0});const e=a(605),r=a(145),n=a(82),s=a(222);!function(){const t=new e.SerialPort({path:"/dev/serial/by-id/usb-Prolific_Technology_Inc._USB-Serial_Controller_DIDSt114J20-if00-port0",baudRate:2400,dataBits:8,parity:"none",stopBits:1}),a=new r.TelegramReader,i=new s.MultiTelegramReader(a);t.on("data",(function(t){if(console.log([...t]),a.addRawData([...t])==n.TelegramState.available){const t=a.getTelegrams();if(console.log(JSON.stringify(t)),i.addTelegrams(t)==n.ApplicationDataState.available){const t=i.getApplicationDataUnits();console.log(JSON.stringify(t))}}})),t.on("error",(function(t){console.error("Error: ",t.message)}))}()})(),i)this[r]=i[r];i.__esModule&&Object.defineProperty(this,"__esModule",{value:!0})})();
//# sourceMappingURL=index.js.map